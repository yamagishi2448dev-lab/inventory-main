# Functional Requirements (v2.3)

## Auth / User Management（認証・ユーザー管理）

### ログイン
- ユーザー名 + パスワード
- ログイン失敗時は原因を特定できない文言にする
- セッション: DB永続化、Cookie名 `inventory_session`、有効期限7日
- Cookie属性: `HttpOnly`, `SameSite=Lax`, 本番`Secure`

### ユーザー管理（ADMIN権限）
- 管理者コンソール: ヘッダーメニューからアクセス（ADMINのみ表示）
- ユーザー一覧: ユーザー名/ロール/作成日時（`YYYY/MM/DD HH:MM`）
- ロールバッジ: ADMIN=赤、USER=グレー
- 新規ユーザー: username(3-50, 英数字/アンダースコア/ハイフン), password(>=8), role
- ユーザー編集: ユーザー名/ロールのみ（パスワードは別途リセット）
- パスワードリセット: 対象ユーザーの全セッション削除
- ユーザー削除: 自分自身/最後のADMINは削除不可
- 自分のパスワード変更: 現在PW確認 + 全セッション削除

### 権限
- ADMIN: ユーザー管理 + システム設定 + 全機能
- USER: 商品/委託品/マスタCRUD

---

## Product Management（商品管理）

### 一覧表示
- 20件/ページ、検索 + フィルタ + ページネーション + ソート
- 表示列: メーカー/品目/商品名/仕様/サイズ/張地・カラー/個数/原価単価/場所/デザイナー
- ビュー切替: テーブルビュー / グリッドビュー（2列カード）
- 検索: 商品名/仕様の部分一致（300msデバウンス）
- フィルタ: メーカー, 品目, 場所, タグ（OR条件）, 販売済み

### 選択・一括操作
- 行選択: チェックボックス（複数選択可）
- 全件選択: フィルタ結果の全件選択（ページ外含む、最大100件）
- 一括削除: 選択商品を一括削除
- 一括編集: 場所/メーカー/品目/タグ/個数を一括更新
  - 個数: 設定モード（固定値）/ 増減モード（+/-）

### 詳細・編集
- 詳細: 全フィールド + 画像ギャラリー + 素材情報 + タグ
- 画像: 追加/削除/並び替え可能（最大5枚）
- 素材: 素材項目ごとに説明+画像1枚（MaterialEditor）
- タグ: 複数タグ付与可能
- 販売済み: トグルで切替、販売日時を自動記録

### SKU自動採番
- 形式: `SKU-00001`（5桁ゼロ埋め）
- 作成時に自動採番、編集不可
- SystemSettingでカウンター管理（トランザクション安全）

### 削除
- 物理削除
- 画像はCascade削除
- 変更履歴に記録

---

## Consignment Management（委託品管理）

商品管理と同等の機能。以下の差異のみ:

- SKU形式: `CSG-00001`（5桁ゼロ埋め）
- 原価単価（costPrice）: 常に0
- その他: 商品と同じ機能（一覧、詳細、編集、画像、素材、タグ、一括操作）

---

## Tag Management（タグ管理）v2.2

### タグマスタ
- CRUD操作
- 参照カウント表示（商品数/委託品数）
- 重複チェック

### タグ付与
- 商品・委託品に複数タグを付与可能
- 多対多リレーション

### タグフィルタ
- OR条件: 指定タグのいずれかを持つ商品/委託品を表示
- 複数タグ選択可能

---

## Material Management（素材管理）v2.1

### 素材項目マスタ（MaterialType）
- CRUD操作
- 表示順（order）管理
- 例: 張地、木部、脚部、金具など

### 商品/委託品素材
- 素材項目ごとに:
  - 説明（自由記述）
  - 画像1枚（任意）
  - 表示順
- MaterialEditor UIで管理

---

## Image Upload（画像アップロード）

- ドラッグ&ドロップ対応
- プレビュー表示
- 形式: JPEG/PNG/WebP
- 最大: 5MB/ファイル
- 最大枚数: 5枚/商品（委託品も同様）
- 保存先: Cloudinary（本番環境）
- ファイル名サニタイズ

---

## Master Data（マスタデータ管理）

### 共通機能
- CRUD操作（作成/読取/更新/削除）
- 参照カウント表示（商品数/委託品数）
- 削除時はProduct/Consignmentの参照をSetNull

### マスタ種別
- Manufacturer（メーカー）: 仕入先・ブランド名
- Category（品目）: 商品分類（ソファ、チェアなど）
- Location（場所）: 保管場所
- Unit（単位）: 数量単位（台、個、枚など）

---

## CSV Import/Export（CSVインポート/エクスポート）

### エクスポート
- 全商品/委託品をCSV出力
- BOM付きUTF-8（Excel対応）
- 日本語ヘッダー
- タグはパイプ区切り（`タグ1|タグ2|タグ3`）
- フィルタ適用可能

### インポート
- CSVテンプレート取得可能
- 必須カラム: 商品名, 原価単価
- マスタデータ自動作成（存在しない場合）
- タグのパイプ区切り解析
- バリデーション + エラー行通知
- 販売済み/販売日時のパース対応

---

## Bulk Operations（一括操作）

### 選択
- チェックボックスで複数選択
- 全件選択（フィルタ結果、ページ外含む）
- 選択件数表示

### 一括削除
- 最大100件
- 確認ダイアログ

### 一括編集
- 対象フィールド:
  - 場所（Location）
  - メーカー（Manufacturer）
  - 品目（Category）
  - タグ（複数タグ置き換え）
  - 個数（設定/増減モード）
- BulkEditDialog UIで操作

---

## Change Log（変更履歴）v2.1

### 記録対象
- 商品・委託品の作成/更新/削除
- entityType: "product" | "consignment"
- action: "create" | "update" | "delete"

### 記録内容
- entityName, entitySku: 削除後も表示可能
- changes: 変更前後の差分（JSON）
- userId, userName: 操作ユーザー
- createdAt: 操作日時

### 表示
- 最近の変更（ダッシュボード）
- 変更履歴一覧（API経由）

---

## Dashboard（ダッシュボード）

### 統計情報
- 商品総数
- 品目数
- メーカー数
- 全商品の原価合計（DB側でSUM計算）

### メーカー別原価合計
- 昇順/降順ソート可能
- グラフ表示

### 最近の変更
- 追加/更新の最新10件程度
- 変更履歴から取得

---

## Print Layout（印刷レイアウト）

### 仕様
- A4固定: 2列×2行（4件/ページ）
- 印刷対象: 選択済み商品/委託品のみ
- ブラウザ印刷 + PDF対応

### 表示項目
- 商品写真（1枚目）
- メーカー
- 商品名
- 仕様
- 張地/カラー
- 定価
- 個数
- 単位
- 備考

### 制限
- スマホは印刷機能非対応（デスクトップのみ）

---

## System Settings（システム設定）v2.1

### SKU採番
- `next_product_sku`: 次の商品SKU番号
- `next_consignment_sku`: 次の委託品SKU番号
- トランザクション安全な採番

### 運用ルール
- キー・バリュー形式で保存
- ADMIN権限で更新可能
