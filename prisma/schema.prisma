// This is your Prisma schema file - v2.1

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("POSTGRES_URL")
}

// ユーザー
model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  role         String   @default("USER")
  createdAt    DateTime @default(now())
  sessions     Session[]

  @@map("users")
}

// セッション
model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// 商品 v2.1
model Product {
  id             String         @id @default(cuid())
  sku            String         @unique  // 自動採番: SKU-00001形式
  name           String                  // 商品名（必須）
  manufacturerId String?                 // メーカーID
  categoryId     String?                 // 品目ID
  specification  String?                 // 仕様（自由テキスト）
  size           String?                 // サイズ（v2.1追加）
  fabricColor    String?                 // 張地/カラー（複数行テキスト）
  quantity       Int            @default(0)  // 個数（旧stock）
  unitId         String?                 // 単位ID
  costPrice      Decimal        // 原価単価（必須）
  listPrice      Decimal?       // 定価単価
  arrivalDate    String?                 // 入荷年月（例: "2024年1月"）
  locationId     String?                 // 場所ID
  notes          String?                 // 備考
  isSold         Boolean        @default(false)  // 販売済みフラグ（v2.1追加）
  soldAt         DateTime?               // 販売済み日時（v2.1追加）
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  manufacturer Manufacturer?   @relation(fields: [manufacturerId], references: [id], onDelete: SetNull)
  category     Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  unit         Unit?           @relation(fields: [unitId], references: [id], onDelete: SetNull)
  location     Location?       @relation(fields: [locationId], references: [id], onDelete: SetNull)
  images       ProductImage[]
  materials    ProductMaterial[]  // 素材情報（v2.1追加）

  @@index([manufacturerId])
  @@index([categoryId])
  @@index([locationId])
  @@index([unitId])
  @@index([name])
  @@index([sku])
  @@index([isSold])
  @@map("products")
}

// メーカー（旧Supplier）
model Manufacturer {
  id           String        @id @default(cuid())
  name         String        @unique
  products     Product[]
  consignments Consignment[]  // v2.1追加

  @@map("manufacturers")
}

// 品目（旧Category、用途変更）
model Category {
  id           String        @id @default(cuid())
  name         String        @unique
  products     Product[]
  consignments Consignment[]  // v2.1追加

  @@map("categories")
}

// 場所（旧Tag）
model Location {
  id           String        @id @default(cuid())
  name         String        @unique
  products     Product[]
  consignments Consignment[]  // v2.1追加

  @@map("locations")
}

// 単位
model Unit {
  id           String        @id @default(cuid())
  name         String        @unique
  products     Product[]
  consignments Consignment[]  // v2.1追加

  @@map("units")
}

// 商品画像
model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  order     Int     @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// ============================================
// v2.1 新規モデル
// ============================================

// 素材項目マスタ（v2.1追加）
model MaterialType {
  id        String   @id @default(cuid())
  name      String   @unique  // 張地、木部、脚部など
  order     Int      @default(0)  // 表示順
  createdAt DateTime @default(now())

  materials            ProductMaterial[]
  consignmentMaterials ConsignmentMaterial[]

  @@map("material_types")
}

// 商品素材（v2.1追加）
model ProductMaterial {
  id             String   @id @default(cuid())
  productId      String
  materialTypeId String
  description    String?  // 説明（自由記述）
  imageUrl       String?  // 画像URL（1枚）
  order          Int      @default(0)  // 表示順
  createdAt      DateTime @default(now())

  product      Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  materialType MaterialType @relation(fields: [materialTypeId], references: [id])

  @@index([productId])
  @@index([materialTypeId])
  @@map("product_materials")
}

// システム設定（v2.1追加）
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// 変更履歴（v2.1追加）
model ChangeLog {
  id         String   @id @default(cuid())
  entityType String   // "product" | "consignment"
  entityId   String   // 商品ID または 委託品ID
  entityName String   // 商品名（削除後も表示するため保存）
  entitySku  String   // SKU（削除後も表示するため保存）
  action     String   // "create" | "update" | "delete"
  changes    String?  // 変更内容の詳細（JSON形式）
  userId     String
  userName   String   // ユーザー名（削除後も表示するため保存）
  createdAt  DateTime @default(now())

  @@index([entityType])
  @@index([createdAt])
  @@map("change_logs")
}

// 委託品（v2.1追加）
model Consignment {
  id             String    @id @default(cuid())
  sku            String    @unique  // 自動採番: CSG-00001形式
  name           String              // 商品名（必須）
  manufacturerId String?             // メーカーID
  categoryId     String?             // 品目ID
  specification  String?             // 仕様（自由テキスト）
  size           String?             // サイズ
  fabricColor    String?             // 張地/カラー（複数行テキスト）
  quantity       Int       @default(0)  // 個数
  unitId         String?             // 単位ID
  costPrice      Decimal   // 原価単価（常に0）
  listPrice      Decimal?  // 定価単価
  arrivalDate    String?             // 入荷年月
  locationId     String?             // 場所ID
  notes          String?             // 備考
  isSold         Boolean   @default(false)  // 販売済みフラグ
  soldAt         DateTime?           // 販売済み日時
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  manufacturer Manufacturer? @relation(fields: [manufacturerId], references: [id], onDelete: SetNull)
  category     Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  unit         Unit?         @relation(fields: [unitId], references: [id], onDelete: SetNull)
  location     Location?     @relation(fields: [locationId], references: [id], onDelete: SetNull)
  images       ConsignmentImage[]
  materials    ConsignmentMaterial[]

  @@index([manufacturerId])
  @@index([categoryId])
  @@index([locationId])
  @@index([unitId])
  @@index([name])
  @@index([sku])
  @@index([isSold])
  @@map("consignments")
}

// 委託品画像（v2.1追加）
model ConsignmentImage {
  id            String @id @default(cuid())
  consignmentId String
  url           String
  order         Int    @default(0)

  consignment Consignment @relation(fields: [consignmentId], references: [id], onDelete: Cascade)

  @@index([consignmentId])
  @@map("consignment_images")
}

// 委託品素材（v2.1追加）
model ConsignmentMaterial {
  id             String   @id @default(cuid())
  consignmentId  String
  materialTypeId String
  description    String?  // 説明（自由記述）
  imageUrl       String?  // 画像URL（1枚）
  order          Int      @default(0)  // 表示順
  createdAt      DateTime @default(now())

  consignment  Consignment  @relation(fields: [consignmentId], references: [id], onDelete: Cascade)
  materialType MaterialType @relation(fields: [materialTypeId], references: [id])

  @@index([consignmentId])
  @@index([materialTypeId])
  @@map("consignment_materials")
}
