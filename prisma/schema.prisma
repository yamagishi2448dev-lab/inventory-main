// This is your Prisma schema file - v3.0 (Item統合)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ユーザー
model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  role         String   @default("USER")
  createdAt    DateTime @default(now())
  sessions     Session[]

  @@map("users")
}

// セッション
model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================
// v3.0 Item統合モデル（Product + Consignment統合）
// ============================================

enum ItemType {
  PRODUCT
  CONSIGNMENT
}

// アイテム（商品・委託品統合）
model Item {
  id             String    @id @default(cuid())
  sku            String    @unique  // 自動採番: SKU-00001 または CSG-00001
  itemType       ItemType  @default(PRODUCT)  // 商品 or 委託品
  name           String              // 商品名（必須）
  manufacturerId String?             // メーカーID
  categoryId     String?             // 品目ID
  specification  String?             // 仕様（自由テキスト）
  size           String?             // サイズ
  fabricColor    String?             // 張地/カラー（複数行テキスト）
  quantity       Int       @default(0)  // 個数
  unitId         String?             // 単位ID
  costPrice      Decimal?            // 原価単価（商品:必須, 委託品:null）
  listPrice      Decimal?            // 定価単価
  arrivalDate    String?             // 入荷年月（例: "2024年1月"）
  locationId     String?             // 場所ID
  designer       String?             // デザイナー
  notes          String?             // 備考
  isSold         Boolean   @default(false)  // 販売済みフラグ
  soldAt         DateTime?           // 販売済み日時
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  manufacturer Manufacturer? @relation(fields: [manufacturerId], references: [id], onDelete: SetNull)
  category     Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  unit         Unit?         @relation(fields: [unitId], references: [id], onDelete: SetNull)
  location     Location?     @relation(fields: [locationId], references: [id], onDelete: SetNull)
  images       ItemImage[]
  materials    ItemMaterial[]
  tags         ItemTag[]

  @@index([itemType])
  @@index([manufacturerId])
  @@index([categoryId])
  @@index([locationId])
  @@index([unitId])
  @@index([name])
  @@index([sku])
  @@index([isSold])
  @@map("items")
}

// アイテム画像
model ItemImage {
  id     String @id @default(cuid())
  itemId String
  url    String
  order  Int    @default(0)

  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@map("item_images")
}

// アイテム素材
model ItemMaterial {
  id             String   @id @default(cuid())
  itemId         String
  materialTypeId String
  description    String?  // 説明（自由記述）
  imageUrl       String?  // 画像URL（1枚）
  order          Int      @default(0)  // 表示順
  createdAt      DateTime @default(now())

  item         Item         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  materialType MaterialType @relation(fields: [materialTypeId], references: [id])

  @@index([itemId])
  @@index([materialTypeId])
  @@map("item_materials")
}

// アイテム-タグ中間テーブル
model ItemTag {
  id        String   @id @default(cuid())
  itemId    String
  tagId     String
  createdAt DateTime @default(now())

  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([itemId, tagId])
  @@index([itemId])
  @@index([tagId])
  @@map("item_tags")
}

// ============================================
// マスタデータ
// ============================================

// メーカー（旧Supplier）
model Manufacturer {
  id    String @id @default(cuid())
  name  String @unique
  items Item[]

  @@map("manufacturers")
}

// 品目
model Category {
  id    String @id @default(cuid())
  name  String @unique
  items Item[]

  @@map("categories")
}

// 場所
model Location {
  id    String @id @default(cuid())
  name  String @unique
  items Item[]

  @@map("locations")
}

// 単位
model Unit {
  id    String @id @default(cuid())
  name  String @unique
  items Item[]

  @@map("units")
}

// タグ
model Tag {
  id           String           @id @default(cuid())
  name         String           @unique
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  items        ItemTag[]

  @@map("tags")
}

// 素材項目マスタ
model MaterialType {
  id        String   @id @default(cuid())
  name      String   @unique  // 張地、木部、脚部など
  order     Int      @default(0)  // 表示順
  createdAt DateTime @default(now())

  materials            ItemMaterial[]

  @@map("material_types")
}

// ============================================
// システム
// ============================================

// システム設定
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// 変更履歴
model ChangeLog {
  id         String   @id @default(cuid())
  entityType String   // "item"（統合後は"item"のみ、旧"product"/"consignment"も互換のため残存）
  entityId   String   // アイテムID
  entityName String   // 商品名（削除後も表示するため保存）
  entitySku  String   // SKU（削除後も表示するため保存）
  action     String   // "create" | "update" | "delete"
  changes    String?  // 変更内容の詳細（JSON形式）
  userId     String
  userName   String   // ユーザー名（削除後も表示するため保存）
  itemType   String?  // "PRODUCT" | "CONSIGNMENT"（v3.0追加、区別用）
  createdAt  DateTime @default(now())

  @@index([entityType])
  @@index([createdAt])
  @@map("change_logs")
}

